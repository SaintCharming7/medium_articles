#install.packages(c("ggplot2", "remotes","wid","dplyr","tidyr", "tidyverse", "readr", "ggthemes"))
# Load the required libraries for this exercise
#library("input name of the package")
# Or you can choose the method below for a cleaner look in the script
package_list<- c("ggplot2","dplyr","tidyr", "tidyverse", "readr", "ggthemes")
lapply(package_list, require, character.only = TRUE)


palma_ratio <- read_csv("palma-ratio.csv")

# Filter data from 2001 onwards
palma_filtered <- palma_ratio %>%
  filter(Year >= 2001)

summary(palma_filtered)

hist(palma_filtered$`Palma ratio (before tax) (World Inequality Database)`)
boxplot(palma_filtered$`Palma ratio (before tax) (World Inequality Database)`)

# median imputation
palma_filtered_medians <- palma_filtered %>%
  group_by(Country) %>%
  summarise(country_median = median(`Palma ratio (before tax) (World Inequality Database)`, 
                                    na.rm = TRUE),
            .groups = 'drop')

str(palma_filtered_medians)
head(palma_filtered_medians)

# Perform median imputation
countries_imputed <- palma_filtered %>%
  left_join(palma_filtered_medians, by = "Country") %>%
  mutate(`Palma ratio (before tax) (World Inequality Database)` = 
           ifelse(is.na(`Palma ratio (before tax) (World Inequality Database)`),
                  country_median,
                  `Palma ratio (before tax) (World Inequality Database)`)) %>%
  select(-country_median)

# Verify the imputation
cat("Before imputation - NA count:", sum(is.na(palma_filtered$`Palma ratio (before tax) (World Inequality Database)`)), "\n")
cat("After imputation - NA count:", sum(is.na(countries_imputed$`Palma ratio (before tax) (World Inequality Database)`)), "\n")

# Check if medians make sense for a few countries
sample_countries <- sample(unique(palma_filtered_medians$Country), 5)
palma_filtered_medians %>% filter(Country %in% sample_countries)

# Check distribution of medians
summary(palma_filtered_medians$country_median)
hist(palma_filtered_medians$country_median, main = "Distribution of Country Medians")

# Check summary statistics comparison
cat("--- BEFORE ---\n")
summary(palma_filtered$`Palma ratio (before tax) (World Inequality Database)`)

cat("\n--- AFTER ---\n")
summary(countries_imputed$`Palma ratio (before tax) (World Inequality Database)`)

# Find top 5 countries with highest median inequality
top_countries <- palma_filtered %>%
  group_by(Country) %>%
  summarise(median_inequality = median(`Palma ratio (before tax) (World Inequality Database)`, na.rm = TRUE)) %>%
  arrange(desc(median_inequality)) %>%
  head(5) %>%
  pull(Country)

# Filter data for only the top 5 countries
top_countries_data <- palma_filtered %>%
  filter(Country %in% top_countries)

# Calculate median by country (to preserve country-specific patterns)
country_medians <- top_countries_data %>%
  group_by(Country) %>%
  summarise(country_median = median(`Palma ratio (before tax) (World Inequality Database)`, 
                                    na.rm = TRUE),
            .groups = 'drop')
head(country_medians)

# Perform median imputation
top_countries_imputed <- top_countries_data %>%
  left_join(country_medians, by = "Country") %>%
  mutate(`Palma ratio (before tax) (World Inequality Database)` = 
           ifelse(is.na(`Palma ratio (before tax) (World Inequality Database)`),
                  country_median,
                  `Palma ratio (before tax) (World Inequality Database)`)) %>%
  select(-country_median)

# Verify the imputation
cat("Before imputation - NA count:", sum(is.na(top_countries_data$`Palma ratio (before tax) (World Inequality Database)`)), "\n")
cat("After imputation - NA count:", sum(is.na(top_countries_imputed$`Palma ratio (before tax) (World Inequality Database)`)), "\n")

# Summary of imputed data
summary(top_countries_imputed)
head(top_countries_imputed)

# Plot to see where imputations occurred
ggplot(top_countries_imputed, aes(x = Year, y = `Palma ratio (before tax) (World Inequality Database)`, 
                                  color = Country)) +
  geom_line(data = top_countries_data, aes(group = Country), color = "gray80", alpha = 0.5) +
  geom_line(linewidth = 1.2) +
  geom_point(data = subset(top_countries_imputed, 
                           is.na(top_countries_data$`Palma ratio (before tax) (World Inequality Database)`)),
             size = 3, shape = 1, color = "red") +
  labs(title = "Top 5 Countries Palma Ratio with Imputed Values (red circles)",
       x = "Year", y = "Palma Ratio") +
  theme_classic()
